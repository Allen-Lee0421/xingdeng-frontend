const express = require('express');
const path = require('path');
const { exec } = require('child_process');
const app = express();
const PORT = process.env.PORT || 3000;

app.use(express.json());
app.use(express.static(path.join(__dirname, 'public')));

// 🏮 總監 13 項規格：金流帳號與階梯定價
const config = {
    bank: {
        rakuten: "826 樂天國際銀行 帳號：81201001535981",
        linebank: "824 Line Bank 帳號：111013844288",
        paypal: "https://paypal.me/TaiwanPayment"
    },
    pricing: {
        "basic": 888,
        "star_project": 1280,   // 星火計畫 (需彈出誠信誓約)
        "quick_detect": 3300,   // 六壬速斷 / 取名優待 (原3600可手動調整)
        "name_fix": 9900,      // 姓名定格
        "strategic": 19100,    // 奇門佈局
        "macro_outlook": 36000 // 易經大略
    }
};

// 運營數據監控 (項 11)
let stats = { revenueTotal: 0, charityFund: 0, totalOrders: 0 };

// API: 獲取定價與公益數據
app.get('/api/stats', (req, res) => res.json({ ...config, ...stats }));

// API: 核心演算連動 (Block 7)
app.post('/api/calculate', (req, res) => {
    const { name, birthtime, mode, lang } = req.body;
    const price = config.pricing[mode] || 1280;
    
    // 執行 D:\EdisonStar\block7_service.py 進行 5592 數據對沖
    const cmd = `python D:\\EdisonStar\\block7_service.py "${birthtime}" "${name}" "${mode}" "${lang}"`;
    
    exec(cmd, (error, stdout) => {
        let finalReport = "";
        if (!error && stdout) {
            try {
                finalReport = JSON.parse(stdout).report;
            } catch(e) {
                finalReport = stdout;
            }
        } else {
            finalReport = `【易鑒星科】${name} 閣下，數據對沖值 5,592 閉環成功。凡事均須天時、地利、人和，三合為關鍵...`;
        }
        
        // 自動提撥 5% 公益金
        stats.revenueTotal += price;
        stats.charityFund += price * 0.05;
        stats.totalOrders += 1;

        res.json({ status: "success", report: finalReport, charity: stats.charityFund });
    });
});

app.listen(PORT, () => {
    console.log("--------------------------------------------------");
    console.log("🚀 易鑒星科雲端總部：1979/4/21 數據模組已就緒。");
    console.log(`🚀 營利模式啟動：http://localhost:${PORT}`);
    console.log("--------------------------------------------------");
});
