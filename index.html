<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>星燈防詐中心 - 自主部署</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b0f0f;
      --panel: #111617;
      --accent: #16ff89;
      --accent-dim: #0acb66;
      --text: #d7e9e7;
      --muted: #9bb7b2;
      --warn: #ff6464;
    }
    body {
      margin: 0;
      background: radial-gradient(1200px 600px at 50% -200px, #09342a 0%, var(--bg) 45%, #000 100%);
      color: var(--text);
      font-family: 'Orbitron', system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      min-height: 100vh;
      display: flex; align-items: center; justify-content: center;
    }
    .wrap {
      width: min(1000px, 92vw);
      background: linear-gradient(180deg, rgba(20, 35, 33,0.6), rgba(12,18,18,0.8));
      border: 1px solid #113a33;
      box-shadow: 0 40px 120px rgba(0,0,0,0.6), inset 0 0 60px rgba(22,255,137,0.06);
      border-radius: 18px;
      padding: 28px;
      backdrop-filter: blur(4px);
    }
    header {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px;
    }
    .brand {
      letter-spacing: 1px;
    }
    .brand h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 600;
      color: var(--accent);
      text-shadow: 0 0 12px rgba(22,255,137,0.25);
    }
    .badge {
      font-size: 12px; color: var(--muted);
    }
    .lang {
      display: flex; gap: 8px; flex-wrap: wrap;
    }
    .lang button {
      background: transparent; border: 1px solid #1f3f38; color: var(--muted);
      padding: 6px 10px; border-radius: 10px; cursor: pointer;
    }
    .lang button.active { border-color: var(--accent); color: var(--text) }

    .panel {
      background: var(--panel);
      border: 1px solid #193b33;
      border-radius: 14px;
      padding: 16px;
      margin-top: 10px;
    }
    .row {
      display: grid; grid-template-columns: 1fr auto; gap: 12px;
    }
    .row input {
      width: 100%; padding: 14px 16px; border-radius: 10px;
      border: 1px solid #245448; background: #0f1414; color: var(--text);
      outline: none;
    }
    .row button {
      background: linear-gradient(90deg, var(--accent) 0%, var(--accent-dim) 100%);
      border: none; color: #042a1f; font-weight: 700;
      padding: 14px 18px; border-radius: 10px; cursor: pointer;
      box-shadow: 0 0 18px rgba(22,255,137,0.35);
    }
    .row button:disabled { filter: grayscale(0.6); opacity: 0.6; cursor: not-allowed; }

    .result {
      margin-top: 14px; font-size: 14px; color: var(--muted);
    }
    .result pre {
      white-space: pre-wrap; word-wrap: break-word; background: #0c1212; padding: 12px; border-radius: 10px; border: 1px solid #173730;
    }

    .grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 14px;
    }
    .plan {
      border: 1px solid #20463e; border-radius: 12px; padding: 16px; background: #0f1414;
    }
    .plan h3 { margin: 0 0 6px 0; color: var(--text); }
    .plan .price { color: var(--accent); font-weight: 600; }

    .pay {
      margin-top: 10px; display: grid; gap: 8px;
    }
    .pay .StripeElement, .pay input[type="text"] {
      padding: 12px; border-radius: 10px; background: #0c1212; border: 1px solid #184136; color: var(--text);
    }
    .pay button {
      background: linear-gradient(90deg, var(--accent) 0%, var(--accent-dim) 100%);
      border: none; color: #042a1f; font-weight: 700;
      padding: 12px; border-radius: 10px; cursor: pointer;
    }
    .note { font-size: 12px; color: var(--muted); }
    .err { color: var(--warn); font-size: 13px; }
    footer { margin-top: 20px; font-size: 12px; color: var(--muted); display: flex; justify-content: space-between; align-items: center; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>星燈防詐中心</h1>
        <div class="badge">Global Data Real-time Sync | A.C LEE Security Lab</div>
      </div>
      <div class="lang">
        <button class="active">繁中</button>
        <button>簡中</button>
        <button>EN</button>
        <button>VN</button>
        <button>PH</button>
        <button>ID</button>
        <button>JP</button>
        <button>KR</button>
      </div>
    </header>

    <section class="panel">
      <div class="row">
        <input id="urlInput" type="url" placeholder="請輸入欲偵測之可疑網址..." />
        <button id="scanBtn">啟動深度取證掃描</button>
      </div>
      <div id="scanResult" class="result"></div>
    </section>

    <section class="grid" style="margin-top: 14px;">
      <div class="plan">
        <h3>個人深度報告</h3>
        <div class="price">NT$ 30 / 次</div>
        <div class="note">包含伺服器物理位置、黑名單信譽評級、歷史攻擊紀錄等。</div>
        <div class="pay">
          <div id="card-personal"></div>
          <button id="payPersonalBtn">立即支付（信用卡）</button>
          <div id="personalStatus" class="note"></div>
          <div id="personalError" class="err"></div>
        </div>
      </div>
      <div class="plan">
        <h3>企業授權方案</h3>
        <div class="price">NT$ 3,888 / 月</div>
        <div class="note">提供 API 授權、優先掃描配額、專屬報表匯出。</div>
        <div class="pay">
          <input id="enterpriseEmail" type="text" placeholder="企業聯絡 Email"/>
          <div id="card-enterprise"></div>
          <button id="subscribeBtn">啟動企業訂閱（信用卡）</button>
          <div id="enterpriseStatus" class="note"></div>
          <div id="enterpriseError" class="err"></div>
        </div>
      </div>
    </section>

    <footer>
      <div>© 星燈防詐中心</div>
      <div>本系統僅供風險初步研判，最終判定請由使用者自行負責。</div>
    </footer>
  </div>

  <script src="https://js.stripe.com/v3/"></script>
  <script>
    const urlInput = document.getElementById('urlInput');
    const scanBtn = document.getElementById('scanBtn');
    const scanResult = document.getElementById('scanResult');

    scanBtn.addEventListener('click', async () => {
      const url = urlInput.value.trim();
      scanBtn.disabled = true;
      scanBtn.textContent = '掃描中...';
      scanResult.innerHTML = '';
      try {
        const res = await fetch('/api/scan', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || '掃描失敗');
        scanResult.innerHTML = `
          <div>掃描結果：</div>
          <pre>${JSON.stringify(data, null, 2)}</pre>
        `;
      } catch (e) {
        scanResult.innerHTML = `<div class="err">錯誤：${e.message}</div>`;
      } finally {
        scanBtn.disabled = false;
        scanBtn.textContent = '啟動深度取證掃描';
      }
    });

    // Stripe init
    let stripe;
    let elements;
    fetch('/api/public-key')
      .then(r => r.json())
      .then(({ publishableKey }) => {
        stripe = Stripe(publishableKey);
        elements = stripe.elements();

        const personalCard = elements.create('card', { hidePostalCode: true });
        personalCard.mount('#card-personal');

        const enterpriseCard = elements.create('card', { hidePostalCode: true });
        enterpriseCard.mount('#card-enterprise');

        document.getElementById('payPersonalBtn').addEventListener('click', () => payOneTime(personalCard));
        document.getElementById('subscribeBtn').addEventListener('click', () => subscribeMonthly(enterpriseCard));
      })
      .catch(err => {
        document.getElementById('personalError').textContent = '支付初始化失敗：' + err.message;
        document.getElementById('enterpriseError').textContent = '支付初始化失敗：' + err.message;
      });

    async function payOneTime(cardElement) {
      const personalStatus = document.getElementById('personalStatus');
      const personalError = document.getElementById('personalError');
      personalStatus.textContent = '建立支付意圖中...';
      personalError.textContent = '';

      try {
        const res = await fetch('/api/create-payment-intent', { method: 'POST' });
        const { clientSecret } = await res.json();

        const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
          payment_method: { card: cardElement }
        });

        if (error) {
          personalError.textContent = error.message;
        } else if (paymentIntent && paymentIntent.status === 'succeeded') {
          personalStatus.textContent = '付款成功！深度報告已解鎖（示範）。';
        } else {
          personalStatus.textContent = '付款狀態：' + (paymentIntent?.status || '未知');
        }
      } catch (e) {
        personalError.textContent = '支付失敗：' + e.message;
      }
    }

    async function subscribeMonthly(cardElement) {
      const enterpriseStatus = document.getElementById('enterpriseStatus');
      const enterpriseError = document.getElementById('enterpriseError');
      enterpriseStatus.textContent = '建立訂閱中...';
      enterpriseError.textContent = '';

      try {
        const email = document.getElementById('enterpriseEmail').value.trim();
        const res = await fetch('/api/create-subscription', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || '建立訂閱失敗');

        const { clientSecret, status } = data;

        if (status === 'requires_confirmation') {
          const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
            payment_method: { card: cardElement }
          });
          if (error) {
            enterpriseError.textContent = error.message;
            return;
          }
          if (paymentIntent.status === 'succeeded') {
            enterpriseStatus.textContent = '企業訂閱啟動成功！';
          } else {
            enterpriseStatus.textContent = '付款狀態：' + paymentIntent.status;
          }
        } else {
          enterpriseStatus.textContent = '企業訂閱狀態：' + status;
        }
      } catch (e) {
        enterpriseError.textContent = '訂閱失敗：' + e.message;
      }
    }
  </script>
</body>
</html>
